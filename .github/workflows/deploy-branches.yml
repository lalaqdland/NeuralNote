name: Deploy NeuralNote (dev/master)

on:
  push:
    branches:
      - dev
      - master
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: "Deploy mode: auto | registry | build"
        required: false
        default: auto
        type: choice
        options:
          - auto
          - registry
          - build
      force_branch:
        description: "Target branch for manual deploy"
        required: false
        default: dev
        type: choice
        options:
          - dev
          - master

concurrency:
  group: deploy-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_branch || github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      HOST_SHANGHAI: ${{ secrets.HOST_SHANGHAI }}
      HOST_HK_NEURALNOTE: ${{ secrets.HOST_HK_NEURALNOTE }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
      ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
      LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}
      DEPLOY_ROOT: /opt/neuralnote
      COMPOSE_FILE: docker-compose.prod.yml
      DEPLOY_USER: root
      DEPLOY_PORT: "22"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve deploy target and metadata
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_DEPLOY_MODE: ${{ github.event.inputs.deploy_mode || 'auto' }}
          INPUT_FORCE_BRANCH: ${{ github.event.inputs.force_branch || '' }}
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF_NAME}"
          if [[ "${EVENT_NAME}" == "workflow_dispatch" && -n "${INPUT_FORCE_BRANCH:-}" ]]; then
            BRANCH="${INPUT_FORCE_BRANCH}"
          fi

          REQUESTED_DEPLOY_MODE="${INPUT_DEPLOY_MODE:-auto}"
          if [[ ! "${REQUESTED_DEPLOY_MODE}" =~ ^(auto|registry|build)$ ]]; then
            REQUESTED_DEPLOY_MODE="auto"
          fi

          MAIN_DOMAIN=""
          DEV_DOMAIN=""

          case "${BRANCH}" in
            dev)
              DEPLOY_HOST="${HOST_SHANGHAI}"
              FRONTEND_BIND_ADDR="0.0.0.0"
              FRONTEND_BIND_PORT="80"
              VERIFY_FRONTEND_URL="http://${DEPLOY_HOST}/"
              VERIFY_BACKEND_URL="http://${DEPLOY_HOST}/api/v1/health/ping"
              ;;
            master)
              DEPLOY_HOST="${HOST_HK_NEURALNOTE}"
              FRONTEND_BIND_ADDR="127.0.0.1"
              FRONTEND_BIND_PORT="18080"
              MAIN_DOMAIN="neuralnote.capoo.tech"
              DEV_DOMAIN="dev.neuralnote.capoo.tech"
              VERIFY_FRONTEND_URL="https://${MAIN_DOMAIN}/"
              VERIFY_BACKEND_URL="https://${MAIN_DOMAIN}/api/v1/health/ping"
              ;;
            *)
              echo "Unsupported branch: ${BRANCH}" >&2
              exit 1
              ;;
          esac

          : "${DEPLOY_HOST:?DEPLOY_HOST is required for branch ${BRANCH}}"
          : "${SSH_PRIVATE_KEY:?SSH_PRIVATE_KEY is required}"

          REGISTRY_CONFIGURED="false"
          REGISTRY_HOST=""
          REGISTRY_NS=""
          SHA_TAG="${GITHUB_SHA::12}"
          BACKEND_IMAGE_SHA=""
          BACKEND_IMAGE_BRANCH=""
          FRONTEND_IMAGE_SHA=""
          FRONTEND_IMAGE_BRANCH=""

          if [[ -n "${ALIYUN_REGISTRY:-}" && -n "${ALIYUN_REGISTRY_USER:-}" && -n "${ALIYUN_REGISTRY_PASSWORD:-}" ]]; then
            REGISTRY_CONFIGURED="true"
            REGISTRY_INPUT="${ALIYUN_REGISTRY#http://}"
            REGISTRY_INPUT="${REGISTRY_INPUT#https://}"
            REGISTRY_INPUT="${REGISTRY_INPUT%/}"
            if [[ "${REGISTRY_INPUT}" == */* ]]; then
              REGISTRY_NS="${REGISTRY_INPUT}"
              REGISTRY_HOST="${REGISTRY_INPUT%%/*}"
            else
              REGISTRY_HOST="${REGISTRY_INPUT}"
              REGISTRY_NS="${REGISTRY_INPUT}/capoo"
            fi

            BACKEND_IMAGE_SHA="${REGISTRY_NS}/neuralnote-backend:${SHA_TAG}"
            BACKEND_IMAGE_BRANCH="${REGISTRY_NS}/neuralnote-backend:${BRANCH}-latest"
            FRONTEND_IMAGE_SHA="${REGISTRY_NS}/neuralnote-frontend:${SHA_TAG}"
            FRONTEND_IMAGE_BRANCH="${REGISTRY_NS}/neuralnote-frontend:${BRANCH}-latest"
          fi

          RELEASE_ID="$(date -u +%Y%m%d%H%M%S)"
          ARCHIVE_NAME="neuralnote_release_${RELEASE_ID}.tar.gz"
          HEALTHCHECK_FRONTEND_URL="http://127.0.0.1:${FRONTEND_BIND_PORT}/"
          HEALTHCHECK_BACKEND_URL="http://127.0.0.1:${FRONTEND_BIND_PORT}/api/v1/health/ping"

          {
            echo "BRANCH=${BRANCH}"
            echo "REQUESTED_DEPLOY_MODE=${REQUESTED_DEPLOY_MODE}"
            echo "DEPLOY_HOST=${DEPLOY_HOST}"
            echo "REGISTRY_CONFIGURED=${REGISTRY_CONFIGURED}"
            echo "REGISTRY_HOST=${REGISTRY_HOST}"
            echo "REGISTRY_NS=${REGISTRY_NS}"
            echo "SHA_TAG=${SHA_TAG}"
            echo "BACKEND_IMAGE_SHA=${BACKEND_IMAGE_SHA}"
            echo "BACKEND_IMAGE_BRANCH=${BACKEND_IMAGE_BRANCH}"
            echo "FRONTEND_IMAGE_SHA=${FRONTEND_IMAGE_SHA}"
            echo "FRONTEND_IMAGE_BRANCH=${FRONTEND_IMAGE_BRANCH}"
            echo "FRONTEND_BIND_ADDR=${FRONTEND_BIND_ADDR}"
            echo "FRONTEND_BIND_PORT=${FRONTEND_BIND_PORT}"
            echo "VERIFY_FRONTEND_URL=${VERIFY_FRONTEND_URL}"
            echo "VERIFY_BACKEND_URL=${VERIFY_BACKEND_URL}"
            echo "HEALTHCHECK_FRONTEND_URL=${HEALTHCHECK_FRONTEND_URL}"
            echo "HEALTHCHECK_BACKEND_URL=${HEALTHCHECK_BACKEND_URL}"
            echo "RELEASE_ID=${RELEASE_ID}"
            echo "ARCHIVE_NAME=${ARCHIVE_NAME}"
            echo "MAIN_DOMAIN=${MAIN_DOMAIN}"
            echo "DEV_DOMAIN=${DEV_DOMAIN}"
          } >> "${GITHUB_ENV}"

      - name: Build release archive
        shell: bash
        run: |
          set -euo pipefail
          git archive --format=tar.gz --output="${ARCHIVE_NAME}" "${GITHUB_SHA}"
          test -s "${ARCHIVE_NAME}"

      - name: Prepare SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "${SSH_PRIVATE_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${DEPLOY_PORT}" -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Setup HK edge proxy (master only)
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${BRANCH}" != "master" ]]; then
            echo "[edge] Skip HK edge setup for branch ${BRANCH}"
            exit 0
          fi
          scp -P "${DEPLOY_PORT}" "scripts/setup_hk_edge_proxy.sh" "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/setup_hk_edge_proxy.sh"
          ssh -p "${DEPLOY_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "\
            set -euo pipefail; \
            chmod +x /tmp/setup_hk_edge_proxy.sh; \
            MAIN_DOMAIN='${MAIN_DOMAIN}' \
            DEV_DOMAIN='${DEV_DOMAIN}' \
            SHANGHAI_UPSTREAM='http://47.101.214.41:80' \
            DEV_UPSTREAM_HOST_HEADER='47.101.214.41' \
            HK_LOCAL_UPSTREAM='http://127.0.0.1:18080' \
            LETSENCRYPT_EMAIL='${LETSENCRYPT_EMAIL}' \
            bash /tmp/setup_hk_edge_proxy.sh; \
            rm -f /tmp/setup_hk_edge_proxy.sh\
          "

      - name: Attempt registry publish
        id: registry_publish
        continue-on-error: true
        shell: bash
        run: |
          set -u

          if [[ "${REQUESTED_DEPLOY_MODE}" == "build" ]]; then
            echo "attempted=false" >> "${GITHUB_OUTPUT}"
            echo "result=skipped_requested_build_mode" >> "${GITHUB_OUTPUT}"
            echo "[deploy] Registry publish skipped: requested build mode."
            exit 0
          fi

          if [[ "${REGISTRY_CONFIGURED}" != "true" ]]; then
            echo "attempted=false" >> "${GITHUB_OUTPUT}"
            echo "result=skipped_registry_not_configured" >> "${GITHUB_OUTPUT}"
            echo "[deploy] Registry publish skipped: registry secrets are not fully configured."
            exit 0
          fi

          echo "attempted=true" >> "${GITHUB_OUTPUT}"
          set +e

          echo "${ALIYUN_REGISTRY_PASSWORD}" | docker login "${REGISTRY_HOST}" -u "${ALIYUN_REGISTRY_USER}" --password-stdin
          rc=$?

          if [[ "${rc}" -eq 0 ]]; then
            docker build \
              -f src/backend/Dockerfile \
              -t "${BACKEND_IMAGE_SHA}" \
              -t "${BACKEND_IMAGE_BRANCH}" \
              .
            rc=$?
          fi

          if [[ "${rc}" -eq 0 ]]; then
            docker push "${BACKEND_IMAGE_SHA}"
            rc=$?
          fi

          if [[ "${rc}" -eq 0 ]]; then
            docker push "${BACKEND_IMAGE_BRANCH}"
            rc=$?
          fi

          if [[ "${rc}" -eq 0 ]]; then
            docker build \
              -f src/frontend/Dockerfile \
              -t "${FRONTEND_IMAGE_SHA}" \
              -t "${FRONTEND_IMAGE_BRANCH}" \
              ./src/frontend
            rc=$?
          fi

          if [[ "${rc}" -eq 0 ]]; then
            docker push "${FRONTEND_IMAGE_SHA}"
            rc=$?
          fi

          if [[ "${rc}" -eq 0 ]]; then
            docker push "${FRONTEND_IMAGE_BRANCH}"
            rc=$?
          fi

          if [[ "${rc}" -eq 0 ]]; then
            echo "result=success" >> "${GITHUB_OUTPUT}"
            echo "[deploy] Registry publish succeeded."
            exit 0
          fi

          echo "result=failed" >> "${GITHUB_OUTPUT}"
          echo "[deploy] Registry publish failed with exit code: ${rc}"
          exit "${rc}"

      - name: Decide final deploy mode
        id: mode_decision
        shell: bash
        env:
          REGISTRY_STEP_OUTCOME: ${{ steps.registry_publish.outcome }}
          REGISTRY_STEP_ATTEMPTED: ${{ steps.registry_publish.outputs.attempted }}
          REGISTRY_STEP_RESULT: ${{ steps.registry_publish.outputs.result }}
        run: |
          set -euo pipefail

          FINAL_DEPLOY_MODE=""
          FALLBACK_REASON=""

          case "${REQUESTED_DEPLOY_MODE}" in
            build)
              FINAL_DEPLOY_MODE="build"
              FALLBACK_REASON="forced_build_mode"
              ;;
            registry)
              if [[ "${REGISTRY_CONFIGURED}" != "true" ]]; then
                echo "[deploy] Requested registry mode but registry secrets are not configured." >&2
                exit 1
              fi
              if [[ "${REGISTRY_STEP_RESULT}" != "success" ]]; then
                echo "[deploy] Requested registry mode but registry publish failed." >&2
                echo "[deploy] Step outcome: ${REGISTRY_STEP_OUTCOME}, result: ${REGISTRY_STEP_RESULT}" >&2
                exit 1
              fi
              FINAL_DEPLOY_MODE="registry"
              FALLBACK_REASON="forced_registry_mode"
              ;;
            auto)
              if [[ "${REGISTRY_CONFIGURED}" == "true" && "${REGISTRY_STEP_RESULT}" == "success" ]]; then
                FINAL_DEPLOY_MODE="registry"
                FALLBACK_REASON="auto_registry_success"
              elif [[ "${REGISTRY_CONFIGURED}" == "true" && "${REGISTRY_STEP_ATTEMPTED}" == "true" ]]; then
                FINAL_DEPLOY_MODE="build"
                FALLBACK_REASON="fallback_to_build_registry_failed"
              else
                FINAL_DEPLOY_MODE="build"
                FALLBACK_REASON="fallback_to_build_registry_not_configured"
              fi
              ;;
            *)
              echo "[deploy] Unknown requested deploy mode: ${REQUESTED_DEPLOY_MODE}" >&2
              exit 1
              ;;
          esac

          {
            echo "FINAL_DEPLOY_MODE=${FINAL_DEPLOY_MODE}"
            echo "FALLBACK_REASON=${FALLBACK_REASON}"
            echo "REGISTRY_STEP_OUTCOME=${REGISTRY_STEP_OUTCOME}"
            echo "REGISTRY_STEP_RESULT=${REGISTRY_STEP_RESULT}"
          } >> "${GITHUB_ENV}"

          {
            echo "final_mode=${FINAL_DEPLOY_MODE}"
            echo "fallback_reason=${FALLBACK_REASON}"
          } >> "${GITHUB_OUTPUT}"

          echo "[deploy] Requested mode=${REQUESTED_DEPLOY_MODE}, final mode=${FINAL_DEPLOY_MODE}, reason=${FALLBACK_REASON}"

      - name: Create deploy runtime env file
        shell: bash
        run: |
          set -euo pipefail

          {
            echo "DEPLOY_ROOT=${DEPLOY_ROOT}"
            echo "COMPOSE_FILE=${COMPOSE_FILE}"
            echo "DEPLOY_MODE=${FINAL_DEPLOY_MODE}"
            echo "FRONTEND_BIND_ADDR=${FRONTEND_BIND_ADDR}"
            echo "FRONTEND_BIND_PORT=${FRONTEND_BIND_PORT}"
            echo "HEALTHCHECK_FRONTEND_URL=${HEALTHCHECK_FRONTEND_URL}"
            echo "HEALTHCHECK_BACKEND_URL=${HEALTHCHECK_BACKEND_URL}"
            echo "FINAL_DEPLOY_MODE=${FINAL_DEPLOY_MODE}"
            echo "FALLBACK_REASON=${FALLBACK_REASON}"
          } > deploy_runtime.env

          if [[ "${FINAL_DEPLOY_MODE}" == "registry" ]]; then
            : "${BACKEND_IMAGE_SHA:?BACKEND_IMAGE_SHA is required in registry mode}"
            : "${FRONTEND_IMAGE_SHA:?FRONTEND_IMAGE_SHA is required in registry mode}"
            : "${REGISTRY_HOST:?REGISTRY_HOST is required in registry mode}"
            : "${ALIYUN_REGISTRY_USER:?ALIYUN_REGISTRY_USER is required in registry mode}"
            : "${ALIYUN_REGISTRY_PASSWORD:?ALIYUN_REGISTRY_PASSWORD is required in registry mode}"

            REGISTRY_PASSWORD_B64="$(printf '%s' "${ALIYUN_REGISTRY_PASSWORD}" | base64 | tr -d '\n')"
            {
              echo "BACKEND_IMAGE=${BACKEND_IMAGE_SHA}"
              echo "FRONTEND_IMAGE=${FRONTEND_IMAGE_SHA}"
              echo "REGISTRY_HOST=${REGISTRY_HOST}"
              echo "REGISTRY_USER=${ALIYUN_REGISTRY_USER}"
              echo "REGISTRY_PASSWORD_B64=${REGISTRY_PASSWORD_B64}"
            } >> deploy_runtime.env
          fi

      - name: Upload release and deploy assets
        shell: bash
        run: |
          set -euo pipefail
          scp -P "${DEPLOY_PORT}" "${ARCHIVE_NAME}" "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/${ARCHIVE_NAME}"
          scp -P "${DEPLOY_PORT}" "scripts/deploy_release.sh" "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/deploy_release.sh"
          scp -P "${DEPLOY_PORT}" "deploy_runtime.env" "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/deploy_runtime.env"

      - name: Deploy on target server
        shell: bash
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "\
            set -euo pipefail; \
            set -a; source /tmp/deploy_runtime.env; set +a; \
            if [[ \"\${DEPLOY_MODE}\" == \"registry\" ]]; then \
              export REGISTRY_PASSWORD=\"\$(printf '%s' \"\${REGISTRY_PASSWORD_B64}\" | base64 -d)\"; \
              unset REGISTRY_PASSWORD_B64; \
            fi; \
            bash /tmp/deploy_release.sh /tmp/${ARCHIVE_NAME} ${RELEASE_ID}; \
            rm -f /tmp/${ARCHIVE_NAME} /tmp/deploy_release.sh /tmp/deploy_runtime.env\
          "

      - name: Verify release switch on target
        shell: bash
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "\
            set -euo pipefail; \
            CURRENT_TARGET=\$(readlink -f \"${DEPLOY_ROOT}/current\"); \
            EXPECTED_TARGET=\"${DEPLOY_ROOT}/releases/${RELEASE_ID}\"; \
            echo \"[deploy] current=\${CURRENT_TARGET}\"; \
            echo \"[deploy] expected=\${EXPECTED_TARGET}\"; \
            [[ \"\${CURRENT_TARGET}\" == \"\${EXPECTED_TARGET}\" ]]; \
          "

      - name: Verify public health endpoints
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS --retry 30 --retry-delay 5 "${VERIFY_FRONTEND_URL}" >/dev/null
          curl -fsS --retry 30 --retry-delay 5 "${VERIFY_BACKEND_URL}" | grep -q '"message":"pong"'
          if [[ "${BRANCH}" == "master" ]]; then
            curl -fsS --retry 30 --retry-delay 5 "https://dev.neuralnote.capoo.tech/api/v1/health/ping" | grep -q '"message":"pong"'
          fi
          echo "Deploy verification passed for branch ${BRANCH}: ${VERIFY_FRONTEND_URL}"

      - name: Failure diagnostics
        if: ${{ failure() }}
        continue-on-error: true
        shell: bash
        run: |
          set +e
          echo "[diag] BRANCH=${BRANCH:-unknown}"
          echo "[diag] REQUESTED_DEPLOY_MODE=${REQUESTED_DEPLOY_MODE:-unknown}"
          echo "[diag] FINAL_DEPLOY_MODE=${FINAL_DEPLOY_MODE:-unknown}"
          echo "[diag] FALLBACK_REASON=${FALLBACK_REASON:-unknown}"
          echo "[diag] REGISTRY_CONFIGURED=${REGISTRY_CONFIGURED:-unknown}"
          echo "[diag] REGISTRY_STEP_OUTCOME=${REGISTRY_STEP_OUTCOME:-unknown}"
          echo "[diag] REGISTRY_STEP_RESULT=${REGISTRY_STEP_RESULT:-unknown}"
          echo "[diag] DEPLOY_HOST=${DEPLOY_HOST:-unknown}"
          echo "[diag] RELEASE_ID=${RELEASE_ID:-unknown}"

          ssh -p "${DEPLOY_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "\
            set +e; \
            echo '[diag] remote_current='\"\$(readlink -f ${DEPLOY_ROOT}/current 2>/dev/null || true)\"; \
            if [[ -f ${DEPLOY_ROOT}/current/${COMPOSE_FILE} ]]; then \
              cd ${DEPLOY_ROOT}/current; \
              if [[ -f .deploy-images.env ]]; then \
                docker compose --env-file .deploy-images.env -f ${COMPOSE_FILE} ps || true; \
              else \
                docker compose -f ${COMPOSE_FILE} ps || true; \
              fi; \
            fi; \
          " || true

      - name: Deployment summary
        if: ${{ always() }}
        shell: bash
        run: |
          {
            echo "## Deploy Summary"
            echo ""
            echo "- Job status: ${{ job.status }}"
            echo "- Branch: ${BRANCH}"
            echo "- Deploy host: ${DEPLOY_HOST}"
            echo "- Requested mode: ${REQUESTED_DEPLOY_MODE}"
            echo "- Final mode: ${FINAL_DEPLOY_MODE:-unknown}"
            echo "- Fallback reason: ${FALLBACK_REASON:-unknown}"
            echo "- Registry configured: ${REGISTRY_CONFIGURED}"
            echo "- Registry step outcome: ${REGISTRY_STEP_OUTCOME:-unknown}"
            echo "- Registry step result: ${REGISTRY_STEP_RESULT:-unknown}"
            echo "- Release id: ${RELEASE_ID}"
            echo "- Verify frontend url: ${VERIFY_FRONTEND_URL}"
            echo "- Verify backend url: ${VERIFY_BACKEND_URL}"
          } >> "${GITHUB_STEP_SUMMARY}"
