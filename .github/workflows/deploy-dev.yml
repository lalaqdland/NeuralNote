name: Deploy NeuralNote (dev)

on:
  push:
    branches:
      - dev
  workflow_dispatch:

concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      DEPLOY_ROOT: /opt/neuralnote
      COMPOSE_FILE: docker-compose.prod.yml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate deploy secrets
        shell: bash
        run: |
          set -euo pipefail
          : "${DEPLOY_HOST:?DEPLOY_HOST is required}"
          : "${DEPLOY_USER:?DEPLOY_USER is required}"
          : "${DEPLOY_SSH_KEY:?DEPLOY_SSH_KEY is required}"

      - name: Prepare SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "${DEPLOY_SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${DEPLOY_PORT:-22}" -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Build release archive
        shell: bash
        run: |
          set -euo pipefail
          RELEASE_ID="$(date -u +%Y%m%d%H%M%S)"
          ARCHIVE_NAME="neuralnote_release_${RELEASE_ID}.tar.gz"
          tar -czf "${ARCHIVE_NAME}" \
            --exclude='./.git' \
            --exclude='./venv' \
            --exclude='./src/frontend/node_modules' \
            --exclude='./src/frontend/dist' \
            --exclude='./neuralnote_deploy.tar' \
            --exclude='./neuralnote_release_*.tar.gz' \
            .
          echo "RELEASE_ID=${RELEASE_ID}" >> "${GITHUB_ENV}"
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> "${GITHUB_ENV}"

      - name: Upload archive and deploy script
        shell: bash
        run: |
          set -euo pipefail
          scp -P "${DEPLOY_PORT:-22}" "${ARCHIVE_NAME}" "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/${ARCHIVE_NAME}"
          scp -P "${DEPLOY_PORT:-22}" "scripts/deploy_release.sh" "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/deploy_release.sh"

      - name: Deploy on server
        shell: bash
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT:-22}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "set -euo pipefail; \
            DEPLOY_ROOT='${DEPLOY_ROOT}' COMPOSE_FILE='${COMPOSE_FILE}' \
            bash /tmp/deploy_release.sh /tmp/${ARCHIVE_NAME} ${RELEASE_ID}; \
            rm -f /tmp/${ARCHIVE_NAME} /tmp/deploy_release.sh"

      - name: Verify public health endpoints
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS --retry 30 --retry-delay 5 "http://${DEPLOY_HOST}/" >/dev/null
          curl -fsS --retry 30 --retry-delay 5 "http://${DEPLOY_HOST}/api/v1/health/ping" >/dev/null
          echo "Deploy verification passed."
